Roguewar — Phase 4a

Host-Authoritative Peer-to-Peer Redesign (Static / GitHub Pages Compatible)

Purpose

Refactor the existing Phase 3–4 implementation from server-authoritative multiplayer to a host-authoritative peer-to-peer model that runs entirely as a static application (e.g. via github.io).

There is no backend server. One client acts as both player and authority. Other clients connect directly to that host.

This phase is architectural and correctness-critical.

⸻

Non-Negotiable Constraints
	•	❌ No backend services
	•	❌ No persistent server processes
	•	❌ No server-side validation
	•	✔ Static hosting only
	•	✔ Deterministic rules engine already implemented
	•	✔ TypeScript only
	•	✔ Browser-native APIs only

⸻

Revised Trust & Authority Model

Authority
	•	One player is the Host
	•	The Host:
	•	Owns the canonical GameState
	•	Owns the RNG seed
	•	Resolves all turns
	•	Validates all player actions
	•	Broadcasts authoritative deltas

Peers
	•	Peers:
	•	Submit intent only
	•	Never resolve combat
	•	Never advance turns
	•	Must reconcile to host state

Rule: If host and peer disagree, the host is always correct.

⸻

Networking Model

Transport
	•	Use WebRTC DataChannels for peer-to-peer messaging
	•	Use public STUN servers only
	•	No TURN unless absolutely required

Signalling
	•	Manual room code exchange or lightweight third-party signalling
	•	Signalling must be optional and replaceable

⸻

Codebase Restructure (Mandatory)

Refactor into explicit layers:

/shared
  rules/          ← deterministic game logic (unchanged)
  types/          ← shared protocol & state types

/authority
  hostEngine.ts   ← turn resolution, validation, RNG
  hostNetwork.ts ← broadcast deltas, receive intents

/client
  renderer/
  input/
  prediction/
  peerNetwork.ts ← WebRTC peer logic

/app
  bootstrap.ts   ← host/peer selection

Host client = authority + client
Peer client = client only

No authority logic may be callable from peer code.

⸻

Protocol Definitions

ActionIntent (Peer → Host)

{
  type: "ACTION_INTENT"
  playerId: string
  turn: number
  action: GameAction
}

TurnDelta (Host → Peers)

{
  type: "TURN_DELTA"
  turn: number
  events: GameEvent[]
  stateHash: string
}

Peers must never derive game state independently.

⸻

Turn Flow (Authoritative)
	1.	Peers send ActionIntent
	2.	Host validates via rules engine
	3.	Host resolves the full turn
	4.	Host emits TurnDelta
	5.	Peers apply delta + animate

All timing is turn-based, not real-time.

⸻

RNG Rules
	•	RNG seed generated by host on game creation
	•	RNG advances only in authority layer
	•	RNG state never exposed directly to peers

⸻

Cheat & Failure Model (Explicit)
	•	Host can cheat → accepted trade-off
	•	PvP is casual / social
	•	If host disconnects → session ends

No host migration in this phase.

⸻

Required Refactors
	•	Remove server references
	•	Replace WebSocket logic with WebRTC
	•	Move authority logic out of networking layer
	•	Enforce one-way authority boundaries
	•	Ensure peers cannot call turn resolution

⸻

Acceptance Criteria

✔ Game runs entirely from static hosting
✔ Host and peers stay in sync
✔ Illegal peer actions are rejected
✔ Host alone advances turns
✔ Deterministic replay works when logged

⸻

Explicit Non-Goals
	•	Ranked PvP
	•	Anti-cheat
	•	Persistence
	•	Matchmaking

⸻

Implementation Order
	1.	Isolate authority logic
	2.	Introduce host/peer bootstrap
	3.	Implement WebRTC transport
	4.	Wire intents → host → deltas
	5.	Remove server code
	6.	Validate determinism

⸻

Guiding Principle

Authority is a role, not a machine.

The architecture must allow the authority role to move back to a server later without rewriting the game.